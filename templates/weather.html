{% extends "base.html" %}

{% block page_title %}天气显示{% endblock %}

{% block content %}
<div class="weather-content">
    <div class="content-section">
        <div class="section-header">
            <div class="section-title">天气查询</div>
        </div>
        <div class="weather-search">
            <input type="text" id="cityInput" placeholder="输入城市名称" value="北京">
            <button id="searchWeather" class="btn">查询天气</button>
        </div>
        <div id="weatherContent">
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-cloud-sun" style="font-size: 64px; color: var(--accent); margin-bottom: 20px;"></i>
                <p style="color: var(--gray-light);">请输入城市名称查询天气信息</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 绑定天气查询事件
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchWeather').addEventListener('click', searchWeather);
        searchWeather(); // 初始加载北京天气
    });

    // 搜索天气
    function searchWeather() {
        const cityName = document.getElementById('cityInput').value;
        const weatherContent = document.getElementById('weatherContent');

        weatherContent.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--accent); margin-bottom: 20px;"></i>
                <p style="color: var(--gray-light);">查询中...</p>
            </div>
        `;

        // 调用后端API
        fetch(`/api/weather?city=${encodeURIComponent(cityName)}`)
            .then(response => response.json())
            .then(weatherData => {
                displayWeatherData(weatherData);
            })
            .catch(error => {
                console.error('Error fetching weather data:', error);
                weatherContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                        <p style="color: var(--gray-light);">获取天气信息失败，请稍后重试</p>
                    </div>
                `;
            });
    }

    // 显示天气数据
    function displayWeatherData(weatherData) {
        const weatherContent = document.getElementById('weatherContent');

        if (!weatherData || !weatherData.daily || weatherData.daily.length === 0) {
            weatherContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                    <p style="color: var(--gray-light);">未找到该城市的天气信息</p>
                </div>
            `;
            return;
        }

        const daily = weatherData.daily || [];
        const today = daily[0];

        let html = `
            <div class="current-weather">
                <div class="weather-icon-large">
                    <i class="${getWeatherIcon(today.textDay)}"></i>
                </div>
                <div style="flex: 1;">
                    <div class="weather-temp">${today.tempMax}°C</div>
                    <div class="weather-desc">${today.textDay}</div>
                    <div class="weather-info">
                        <div class="weather-info-item">
                            <span class="weather-info-label">温度范围</span>
                            <span class="weather-info-value">${today.tempMin}°C ~ ${today.tempMax}°C</span>
                        </div>
                        <div class="weather-info-item">
                            <span class="weather-info-label">湿度</span>
                            <span class="weather-info-value">${today.humidity}%</span>
                        </div>
                        <div class="weather-info-item">
                            <span class="weather-info-label">风向</span>
                            <span class="weather-info-value">${today.windDirDay}</span>
                        </div>
                        <div class="weather-info-item">
                            <span class="weather-info-label">风力</span>
                            <span class="weather-info-value">${today.windScaleDay}级</span>
                        </div>
                        <div class="weather-info-item">
                            <span class="weather-info-label">日出</span>
                            <span class="weather-info-value">${today.sunrise}</span>
                        </div>
                        <div class="weather-info-item">
                            <span class="weather-info-label">日落</span>
                            <span class="weather-info-value">${today.sunset}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;

        if (daily.length > 1) {
            html += `
                <div class="section-header" style="margin-top: 30px;">
                    <div class="section-title">未来天气预报</div>
                </div>
                <div class="forecast-container">
            `;

            daily.slice(1, 4).forEach(day => {
                html += `
                    <div class="forecast-day">
                        <div class="forecast-date">${formatDate(day.fxDate)}</div>
                        <div class="forecast-icon">
                            <i class="${getWeatherIcon(day.textDay)}"></i>
                        </div>
                        <div class="forecast-temp">${day.tempMin}°C ~ ${day.tempMax}°C</div>
                        <div>${day.textDay}</div>
                        <div style="font-size: 12px; color: var(--gray-light); margin-top: 5px;">
                            夜间: ${day.textNight}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
        }

        weatherContent.innerHTML = html;
    }

    // 根据天气状况获取图标
    function getWeatherIcon(weatherText) {
        if (!weatherText) return 'fas fa-cloud';
        const text = weatherText.toLowerCase();
        if (text.includes('晴')) return 'fas fa-sun';
        if (text.includes('云') || text.includes('阴')) return 'fas fa-cloud';
        if (text.includes('雨')) return 'fas fa-cloud-rain';
        if (text.includes('雪')) return 'fas fa-snowflake';
        if (text.includes('雷') || text.includes('电')) return 'fas fa-bolt';
        if (text.includes('雾') || text.includes('霾')) return 'fas fa-smog';
        return 'fas fa-cloud';
    }

    // 格式化日期
    function formatDate(dateString) {
        const date = new Date(dateString);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        const weekday = weekdays[date.getDay()];
        return `${month}月${day}日 周${weekday}`;
    }
</script>
{% endblock %}