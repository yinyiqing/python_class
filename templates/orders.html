{% extends "base.html" %}

{% block page_title %}订单管理{% endblock %}

{% block extra_css %}
<style>
    /* 订单状态样式 */
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; min-width: 60px; text-align: center; }
    .status-reserved { background: rgba(255, 193, 7, 0.2); color: var(--color-warning); }
    .status-checked-in { background: rgba(0, 123, 255, 0.2); color: var(--color-accent); }
    .status-completed { background: rgba(40, 167, 69, 0.2); color: var(--color-success); }
    .status-cancelled { background: rgba(108, 117, 125, 0.2); color: var(--color-gray); }
    .status-abnormal { background: rgba(220, 53, 69, 0.2); color: var(--color-danger); }

    /* 支付状态样式 */
    .payment-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; min-width: 70px; text-align: center; }
    .payment-unpaid { background: rgba(220, 53, 69, 0.2); color: var(--color-danger); }
    .payment-partial { background: rgba(255, 193, 7, 0.2); color: var(--color-warning); }
    .payment-paid { background: rgba(40, 167, 69, 0.2); color: var(--color-success); }
    .payment-refunded { background: rgba(108, 117, 125, 0.2); color: var(--color-gray); }

    /* 筛选栏 */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 5px; }
    .filter-group label { white-space: nowrap; }

    /* 统计卡片 */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: var(--color-secondary); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
    .stat-title { font-size: 14px; color: var(--color-gray-light); margin-bottom: 5px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--color-light); }
    .amount { font-weight: 600; color: var(--color-accent); }

    /* 表格操作按钮 */
    .action-buttons { display: flex; gap: 5px; }
    .search-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-container .form-control { flex: 1; min-width: 200px; }

    /* 日期范围选择器 */
    .date-range { display: flex; gap: 10px; align-items: center; }
    .date-range input { max-width: 150px; }
</style>
{% endblock %}

{% block content %}
<div class="content-section">
    <!-- 统计卡片 -->
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-title">今日订单</div><div class="stat-value" id="todayOrders">--</div></div>
        <div class="stat-card"><div class="stat-title">今日入住</div><div class="stat-value" id="todayCheckIns">--</div></div>
        <div class="stat-card"><div class="stat-title">今日退房</div><div class="stat-value" id="todayCheckOuts">--</div></div>
        <div class="stat-card"><div class="stat-title">今日收入</div><div class="stat-value">¥<span id="todayRevenue">--</span></div></div>
    </div>

    <!-- 筛选和搜索栏 -->
    <div class="search-container">
        <input type="text" class="form-control" id="searchInput" placeholder="搜索订单号、客户姓名、房间号...">
        <select class="form-control" id="statusFilter" style="max-width: 150px;">
            <option value="">全部状态</option>
            <option value="预定中">预定中</option>
            <option value="已入住">已入住</option>
            <option value="已完成">已完成</option>
            <option value="已取消">已取消</option>
            <option value="异常">异常</option>
        </select>
        <select class="form-control" id="paymentFilter" style="max-width: 150px;">
            <option value="">全部支付状态</option>
            <option value="未支付">未支付</option>
            <option value="部分支付">部分支付</option>
            <option value="已支付">已支付</option>
            <option value="已退款">已退款</option>
        </select>
        <div class="date-range">
            <input type="date" class="form-control" id="startDate">
            <span>至</span>
            <input type="date" class="form-control" id="endDate">
        </div>
        <button class="btn" id="searchBtn">搜索</button>
        <button class="btn" id="createOrderBtn">新建订单</button>
        <button class="btn btn-secondary" id="exportBtn">导出数据</button>
    </div>

    <!-- 订单表格 -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>订单号</th>
                    <th>客户信息</th>
                    <th>房间信息</th>
                    <th>入住/退房日期</th>
                    <th>天数</th>
                    <th>金额</th>
                    <th>订单状态</th>
                    <th>支付状态</th>
                    <th>操作员工</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
        </table>
    </div>

    <!-- 分页 -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div id="paginationInfo"></div>
        <div class="pagination">
            <button class="btn btn-secondary" id="prevPage">上一页</button>
            <span id="pageInfo" style="margin: 0 15px;"></span>
            <button class="btn btn-secondary" id="nextPage">下一页</button>
        </div>
    </div>
</div>
<!-- 模态框占位 -->
<div id="orderDetailModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="orderDetailContent"></div>
    </div>
</div>
<div id="orderFormModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-modal">&times;</span>
        <h3 id="orderFormTitle">新建订单</h3>
        <form id="orderForm">
            <input type="hidden" id="order_id">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- 第一列 -->
                <div>
                    <div class="form-group">
                        <label for="customer_id">客户：</label>
                        <select id="customer_id" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="room_number">房间：</label>
                        <select id="room_number" class="form-control" required></select>
                        <div id="roomAvailability" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="employee_id">员工：</label>
                        <select id="employee_id" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="special_requests">特殊要求：</label>
                        <textarea id="special_requests" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                
                <!-- 第二列 -->
                <div>
                    <div class="form-group">
                        <label for="check_in_date">入住日期：</label>
                        <input type="date" id="check_in_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="check_out_date">退房日期：</label>
                        <input type="date" id="check_out_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="order_status">订单状态：</label>
                        <select id="order_status" class="form-control">
                            <option value="预定中">预定中</option>
                            <option value="已入住">已入住</option>
                            <option value="已完成">已完成</option>
                            <option value="已取消">已取消</option>
                            <option value="异常">异常</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment_status">支付状态：</label>
                        <select id="payment_status" class="form-control">
                            <option value="未支付">未支付</option>
                            <option value="部分支付">部分支付</option>
                            <option value="已支付">已支付</option>
                            <option value="已退款">已退款</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="total_amount">总金额：</label>
                        <input type="number" id="total_amount" class="form-control" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="paid_amount">已付金额：</label>
                        <input type="number" id="paid_amount" class="form-control" step="0.01" min="0" value="0">
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; border-top: 1px solid var(--color-border); padding-top: 20px;">
                <button type="submit" class="btn">保存</button>
                <button type="button" class="btn btn-secondary close-modal" style="margin-left: 10px;">取消</button>
            </div>
        </form>
    </div>
</div>
<div id="paymentModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>订单支付</h3>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <div style="font-size: 12px; color: var(--color-gray-light);">订单号</div>
                <div style="font-size: 18px; font-weight: 600;" id="paymentOrderId"></div>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>总金额:</span>
                    <span class="amount">¥<span id="paymentTotalAmount">0.00</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>已付金额:</span>
                    <span class="amount">¥<span id="paymentPaidAmount">0.00</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: 600; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <span>待付金额:</span>
                    <span class="amount">¥<span id="paymentDueAmount">0.00</span></span>
                </div>
            </div>
            <div class="form-group">
                <label for="paymentAmount">支付金额：</label>
                <input type="number" id="paymentAmount" class="form-control" step="0.01" min="0.01" required>
            </div>
            <button class="btn" id="confirmPaymentBtn">确认支付</button>
        </div>
    </div>
</div>
<div id="confirmDeleteModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>确认删除</h3>
        <div style="padding: 20px;">
            <p id="deleteConfirmText">确定要删除这个订单吗？</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                <button class="btn btn-secondary close-modal">取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1, totalPages = 1, currentOrderId = '', customers = [], rooms = [], employees = [];

    document.addEventListener('DOMContentLoaded', function() {
        initDatePickers();
        loadCustomers();
        loadRooms();
        loadEmployees();
        loadStatistics();
        loadOrders();
        initEventListeners();
    });

    function initDatePickers() {
        const today = new Date().toISOString().split('T')[0];
        const oneWeekAgo = new Date(); 
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
    }

    function loadStatistics() {
        fetch('/api/orders/statistics')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const s = data.data.today_stats;
                document.getElementById('todayOrders').textContent = s.today_total || 0;
                document.getElementById('todayCheckIns').textContent = s.today_checked_in || 0;
                document.getElementById('todayCheckOuts').textContent = s.today_completed || 0;
                document.getElementById('todayRevenue').textContent = (s.today_total_amount || 0).toFixed(2);
            }
        }).catch(err => console.error(err));
    }

    function loadCustomers() { 
        fetch('/api/customer/list').then(r=>r.json()).then(d=>{ 
            if(d.success){ 
                customers=d.data||[]; 
                const s=document.getElementById('customer_id'); 
                s.innerHTML='<option value="">选择客户</option>'; 
                customers.forEach(c=>{ 
                    let o=document.createElement('option'); 
                    o.value=c.id; 
                    o.textContent=`${c.name} (${c.phone})`; 
                    s.appendChild(o); 
                }); 
            } 
        }).catch(console.error); 
    }
    
    function loadRooms() { 
        fetch('/api/rooms/list').then(r=>r.json()).then(d=>{ 
            if(d.success){ 
                rooms=d.data||[]; 
                const s=document.getElementById('room_number'); 
                s.innerHTML='<option value="">选择房间</option>'; 
                rooms.forEach(rm=>{ 
                    let o=document.createElement('option'); 
                    o.value=rm.room_number; 
                    o.textContent=`${rm.room_number} - ${rm.room_type} (¥${rm.price})`; 
                    s.appendChild(o); 
                }); 
            } 
        }).catch(console.error); 
    }
    
    function loadEmployees() { 
        fetch('/api/employee/list').then(r=>r.json()).then(d=>{ 
            if(d.success){ 
                employees=d.data||[]; 
                const s=document.getElementById('employee_id'); 
                s.innerHTML='<option value="">选择员工</option>'; 
                employees.forEach(e=>{ 
                    let o=document.createElement('option'); 
                    o.value=e.employee_id; 
                    o.textContent=`${e.employee_name} (${e.employee_id})`; 
                    s.appendChild(o); 
                }); 
            } 
        }).catch(console.error); 
    }

    function loadOrders(page=1) {
        const s=document.getElementById('searchInput').value;
        const st=document.getElementById('statusFilter').value;
        const ps=document.getElementById('paymentFilter').value;
        const sd=document.getElementById('startDate').value;
        const ed=document.getElementById('endDate').value;
        let url=`/api/orders?page=${page}`;
        if(s) url+=`&search=${encodeURIComponent(s)}`;
        if(st) url+=`&status=${encodeURIComponent(st)}`;
        if(ps) url+=`&payment_status=${encodeURIComponent(ps)}`;
        if(sd) url+=`&start_date=${encodeURIComponent(sd)}`;
        if(ed) url+=`&end_date=${encodeURIComponent(ed)}`;
        
        fetch(url).then(r=>r.json()).then(d=>{ 
            if(d.success){ 
                renderOrdersTable(d.data); 
                currentPage=page; 
                totalPages=Math.ceil(d.total/10)||1; 
                updatePagination(); 
            } 
        }).catch(console.error);
    }

    function renderOrdersTable(orders) {
        const tbody = document.getElementById('ordersTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">暂无订单数据</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const row = document.createElement('tr');
            
            // 计算入住天数
            const checkInDate = new Date(order.check_in_date);
            const checkOutDate = new Date(order.check_out_date);
            const daysDiff = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
            
            row.innerHTML = `
                <td><a href="javascript:void(0)" onclick="viewOrderDetail('${order.order_id}')">${order.order_id}</a></td>
                <td>${order.customer_name || '--'}<br><small>${order.customer_phone || ''}</small></td>
                <td>${order.room_number || '--'}<br><small>${order.room_type || ''}</small></td>
                <td>${formatDate(order.check_in_date)}<br>${formatDate(order.check_out_date)}</td>
                <td>${daysDiff || 0} 天</td>
                <td class="amount">¥${parseFloat(order.total_amount || 0).toFixed(2)}</td>
                <td><span class="status-badge ${getStatusClass(order.order_status)}">${order.order_status}</span></td>
                <td><span class="payment-badge ${getPaymentClass(order.payment_status)}">${order.payment_status}</span></td>
                <td>${order.employee_name || '--'}</td>
                <td>${formatDateTime(order.created_at)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm" onclick="editOrder('${order.order_id}')">编辑</button>
                        <button class="btn btn-sm btn-success" onclick="processPayment('${order.order_id}')">支付</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteOrder('${order.order_id}')">删除</button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function updatePagination() {
        document.getElementById('pageInfo').textContent=`${currentPage} / ${totalPages}`;
        document.getElementById('prevPage').disabled=currentPage<=1;
        document.getElementById('nextPage').disabled=currentPage>=totalPages;
        document.getElementById('paginationInfo').textContent=`共 ${totalPages} 页`;
    }

    function formatDate(dateString) {
        if (!dateString) return '--';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN');
    }

    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '--';
        const date = new Date(dateTimeString);
        return date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function viewOrderDetail(orderId) {
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.data;
                    const dueAmount = parseFloat(order.total_amount) - parseFloat(order.paid_amount);
                    
                    document.getElementById('orderDetailContent').innerHTML = `
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- 订单基本信息 -->
                                <div>
                                    <h3 style="margin-bottom: 15px; color: var(--color-light);">订单信息</h3>
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 12px; color: var(--color-gray-light);">订单号</div>
                                            <div style="font-size: 18px; font-weight: 600;">${order.order_id}</div>
                                        </div>

                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                            <div>
                                                <div style="font-size: 12px; color: var(--color-gray-light);">订单状态</div>
                                                <span class="status-badge ${getStatusClass(order.order_status)}">${order.order_status}</span>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: var(--color-gray-light);">支付状态</div>
                                                <span class="payment-badge ${getPaymentClass(order.payment_status)}">${order.payment_status}</span>
                                            </div>
                                        </div>

                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div>
                                                <div style="font-size: 12px; color: var(--color-gray-light);">入住日期</div>
                                                <div>${formatDate(order.check_in_date)}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: var(--color-gray-light);">退房日期</div>
                                                <div>${formatDate(order.check_out_date)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 金额信息 -->
                                <div>
                                    <h3 style="margin-bottom: 15px; color: var(--color-light);">金额信息</h3>
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>总金额:</span>
                                            <span class="amount">¥${parseFloat(order.total_amount).toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span>已付金额:</span>
                                            <span class="amount">¥${parseFloat(order.paid_amount).toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-weight: 600; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                            <span>待付金额:</span>
                                            <span class="amount">¥${dueAmount.toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 客户和房间信息 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                                <div>
                                    <h3 style="margin-bottom: 15px; color: var(--color-light);">客户信息</h3>
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 12px; color: var(--color-gray-light);">姓名</div>
                                            <div>${order.customer_name || '--'}</div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 12px; color: var(--color-gray-light);">电话</div>
                                            <div>${order.customer_phone || '--'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--color-gray-light);">身份证</div>
                                            <div>${order.customer_id_card || '--'}</div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 style="margin-bottom: 15px; color: var(--color-light);">房间信息</h3>
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 12px; color: var(--color-gray-light);">房间号</div>
                                            <div>${order.room_number || '--'}</div>
                                        </div>
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 12px; color: var(--color-gray-light);">房间类型</div>
                                            <div>${order.room_type || '--'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 12px; color: var(--color-gray-light);">房间价格</div>
                                            <div>¥${order.room_price || '0.00'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 特殊要求 -->
                            ${order.special_requests ? `
                            <div style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px; color: var(--color-light);">特殊要求</h3>
                                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                    <div>${order.special_requests}</div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- 员工信息 -->
                            <div style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px; color: var(--color-light);">员工信息</h3>
                                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                                    <div>${order.employee_name || '未指定员工'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('orderDetailModal').style.display = 'flex';
                } else {
                    showNotification('获取订单详情失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('获取订单详情失败:', error);
                showNotification('获取订单详情失败', 'error');
            });
    }

    function editOrder(orderId) {
        currentOrderId = orderId;
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.data;
                    document.getElementById('orderFormTitle').textContent = '编辑订单';
                    document.getElementById('order_id').value = order.order_id;
                    document.getElementById('customer_id').value = order.customer_id;
                    document.getElementById('room_number').value = order.room_number;
                    document.getElementById('employee_id').value = order.employee_id || '';
                    document.getElementById('check_in_date').value = order.check_in_date;
                    document.getElementById('check_out_date').value = order.check_out_date;
                    document.getElementById('order_status').value = order.order_status;
                    document.getElementById('payment_status').value = order.payment_status;
                    document.getElementById('total_amount').value = order.total_amount;
                    document.getElementById('paid_amount').value = order.paid_amount;
                    document.getElementById('special_requests').value = order.special_requests || '';

                    checkRoomAvailability(order.room_number, order.check_in_date, order.check_out_date, order.order_id);
                    document.getElementById('orderFormModal').style.display = 'flex';
                } else {
                    showNotification('获取订单信息失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('获取订单信息失败:', error);
                showNotification('获取订单信息失败', 'error');
            });
    }

    function processPayment(orderId) {
        currentOrderId = orderId;
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.data;
                    document.getElementById('paymentOrderId').textContent = order.order_id;
                    document.getElementById('paymentTotalAmount').textContent = parseFloat(order.total_amount).toFixed(2);
                    document.getElementById('paymentPaidAmount').textContent = parseFloat(order.paid_amount).toFixed(2);
                    const dueAmount = parseFloat(order.total_amount) - parseFloat(order.paid_amount);
                    document.getElementById('paymentDueAmount').textContent = dueAmount.toFixed(2);
                    document.getElementById('paymentAmount').value = dueAmount > 0 ? dueAmount : 0;
                    document.getElementById('paymentAmount').max = dueAmount;
                    document.getElementById('paymentModal').style.display = 'flex';
                } else {
                    showNotification('获取订单信息失败: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('获取订单信息失败:', error);
                showNotification('获取订单信息失败', 'error');
            });
    }

    function confirmDeleteOrder(orderId) {
        currentOrderId = orderId;
        fetch(`/api/orders/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.data;
                    document.getElementById('deleteConfirmText').innerHTML = `
                        确定要删除订单 <strong>${order.order_id}</strong> 吗？<br>
                        <small style="color: var(--color-gray-light);">客户：${order.customer_name || '未知'} | 房间：${order.room_number}</small>
                    `;
                    document.getElementById('confirmDeleteModal').style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('获取订单信息失败:', error);
                document.getElementById('confirmDeleteModal').style.display = 'flex';
            });
    }

    function checkRoomAvailability(roomNumber, checkIn, checkOut, excludeOrderId = '') {
        if (!roomNumber || !checkIn || !checkOut) return;

        fetch(`/api/orders/check-availability?room_number=${roomNumber}&check_in=${checkIn}&check_out=${checkOut}&exclude_order_id=${excludeOrderId}`)
            .then(response => response.json())
            .then(data => {
                const availabilityDiv = document.getElementById('roomAvailability');
                if (data.success) {
                    if (data.available) {
                        availabilityDiv.innerHTML = '<span style="color: var(--color-success);"><i class="fas fa-check-circle"></i> 房间可用</span>';
                    } else {
                        availabilityDiv.innerHTML = `<span style="color: var(--color-danger);"><i class="fas fa-times-circle"></i> ${data.message}</span>`;
                    }
                } else {
                    availabilityDiv.innerHTML = `<span style="color: var(--color-warning);"><i class="fas fa-exclamation-triangle"></i> ${data.message}</span>`;
                }
            })
            .catch(error => {
                console.error('检查房间可用性失败:', error);
            });
    }

    function getStatusClass(status) {
        const classMap = {
            '预定中': 'status-reserved',
            '已入住': 'status-checked-in',
            '已完成': 'status-completed',
            '已取消': 'status-cancelled',
            '异常': 'status-abnormal'
        };
        return classMap[status] || 'status-reserved';
    }

    function getPaymentClass(paymentStatus) {
        const classMap = {
            '未支付': 'payment-unpaid',
            '部分支付': 'payment-partial',
            '已支付': 'payment-paid',
            '已退款': 'payment-refunded'
        };
        return classMap[paymentStatus] || 'payment-unpaid';
    }

    function initEventListeners() {
        // 搜索按钮
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn) {
            searchBtn.addEventListener('click', () => {
                currentPage = 1;
                loadOrders();
            });
        }

        // 搜索输入框回车键
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentPage = 1;
                    loadOrders();
                }
            });
        }

        // 筛选条件变化
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                currentPage = 1;
                loadOrders();
            });
        }

        const paymentFilter = document.getElementById('paymentFilter');
        if (paymentFilter) {
            paymentFilter.addEventListener('change', () => {
                currentPage = 1;
                loadOrders();
            });
        }

        // 分页按钮
        const prevPage = document.getElementById('prevPage');
        if (prevPage) {
            prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    loadOrders(currentPage - 1);
                }
            });
        }

        const nextPage = document.getElementById('nextPage');
        if (nextPage) {
            nextPage.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    loadOrders(currentPage + 1);
                }
            });
        }

        // 新建订单按钮
        const createOrderBtn = document.getElementById('createOrderBtn');
        if (createOrderBtn) {
            createOrderBtn.addEventListener('click', () => {
                currentOrderId = '';
                document.getElementById('orderFormTitle').textContent = '新建订单';
                document.getElementById('orderForm').reset();
                document.getElementById('order_id').value = '';
                document.getElementById('order_status').value = '预定中';
                document.getElementById('payment_status').value = '未支付';
                document.getElementById('total_amount').value = '0';
                document.getElementById('paid_amount').value = '0';
                document.getElementById('roomAvailability').innerHTML = '';
                
                // 清空选择框，然后重新加载选项
                const customerSelect = document.getElementById('customer_id');
                const roomSelect = document.getElementById('room_number');
                const employeeSelect = document.getElementById('employee_id');
                
                if (customerSelect) customerSelect.innerHTML = '<option value="">选择客户</option>';
                if (roomSelect) roomSelect.innerHTML = '<option value="">选择房间</option>';
                if (employeeSelect) employeeSelect.innerHTML = '<option value="">选择员工</option>';
                
                // 重新加载数据
                loadCustomers();
                loadRooms();
                loadEmployees();
                
                // 设置默认日期（明天开始，住1天）
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dayAfterTomorrow = new Date(tomorrow);
                dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
                
                document.getElementById('check_in_date').value = tomorrow.toISOString().split('T')[0];
                document.getElementById('check_out_date').value = dayAfterTomorrow.toISOString().split('T')[0];
                
                document.getElementById('orderFormModal').style.display = 'flex';
            });
        }
        // 导出按钮
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                const paymentStatus = document.getElementById('paymentFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                let url = '/api/orders/export?';
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (status) url += `status=${encodeURIComponent(status)}&`;
                if (paymentStatus) url += `payment_status=${encodeURIComponent(paymentStatus)}&`;
                if (startDate) url += `start_date=${encodeURIComponent(startDate)}&`;
                if (endDate) url += `end_date=${encodeURIComponent(endDate)}&`;

                window.open(url, '_blank');
            });
        }

        // 订单表单提交
        const orderForm = document.getElementById('orderForm');
        if (orderForm) {
            orderForm.addEventListener('submit', function(e) {
                e.preventDefault();

                console.log("=== 表单提交开始 ===");
                
                // 收集原始数据
                const rawCustomerId = document.getElementById('customer_id').value;
                const rawEmployeeId = document.getElementById('employee_id').value;
                const rawTotalAmount = document.getElementById('total_amount').value;
                const rawPaidAmount = document.getElementById('paid_amount').value;
                
                console.log("原始数据:", {
                    customer_id: rawCustomerId,
                    employee_id: rawEmployeeId,
                    total_amount: rawTotalAmount,
                    paid_amount: rawPaidAmount
                });
                
                // 数据类型转换函数
                const parseToInt = (value) => {
                    if (!value) return null;
                    const num = parseInt(value);
                    return isNaN(num) ? null : num;
                };
                
                const parseToFloat = (value) => {
                    if (!value) return 0;
                    const num = parseFloat(value);
                    return isNaN(num) ? 0 : num;
                };

                const formData = {
                    customer_id: parseToInt(rawCustomerId), 
                    room_number: document.getElementById('room_number').value,
                    employee_id: parseToInt(rawEmployeeId),
                    check_in_date: document.getElementById('check_in_date').value,
                    check_out_date: document.getElementById('check_out_date').value,
                    order_status: document.getElementById('order_status').value,
                    payment_status: document.getElementById('payment_status').value,
                    total_amount: parseToFloat(rawTotalAmount),
                    paid_amount: parseToFloat(rawPaidAmount),
                    special_requests: document.getElementById('special_requests').value || ''
                };
                
                console.log("转换后的表单数据:", formData);
                
                // 验证必要字段
                const requiredFields = [
                    {field: 'customer_id', name: '客户'},
                    {field: 'room_number', name: '房间'},
                    {field: 'check_in_date', name: '入住日期'},
                    {field: 'check_out_date', name: '退房日期'}
                ];
                
                const missingFields = requiredFields.filter(item => {
                    if (item.field === 'customer_id') {
                        return !formData.customer_id;
                    }
                    return !formData[item.field];
                });
                
                if (missingFields.length > 0) {
                    const fieldNames = missingFields.map(item => item.name).join('、');
                    showNotification(`请填写${fieldNames}`, 'error');
                    return;
                }
                
                // 验证日期
                if (formData.check_in_date && formData.check_out_date) {
                    if (formData.check_in_date >= formData.check_out_date) {
                        showNotification('退房日期必须晚于入住日期', 'error');
                        return;
                    }
                }

                const orderId = document.getElementById('order_id').value;
                const url = orderId ? `/api/orders/${orderId}` : '/api/orders';
                const method = orderId ? 'PUT' : 'POST';
                
                console.log("发送请求到:", url);
                console.log("请求方法:", method);
                console.log("请求数据:", JSON.stringify(formData, null, 2));

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    console.log("响应状态:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("响应数据:", data);
                    if (data.success) {
                        showNotification(data.message, 'success');
                        document.getElementById('orderFormModal').style.display = 'none';
                        loadOrders();
                        loadStatistics();
                    } else {
                        showNotification('保存失败: ' + data.message, 'error');
                        // 如果是房间不可用错误，显示更详细的信息
                        if (data.message.includes('房间')) {
                            console.error("房间可用性错误详情:", data);
                        }
                    }
                })
                .catch(error => {
                    console.error('保存订单失败:', error);
                    showNotification('保存订单失败: ' + error.message, 'error');
                })
                .finally(() => {
                    console.log("=== 表单提交结束 ===");
                });
            });
        }

               

    

        // 确认支付按钮
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
        if (confirmPaymentBtn) {
            confirmPaymentBtn.addEventListener('click', () => {
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                if (!paymentAmount || paymentAmount <= 0) {
                    showNotification('请输入有效的支付金额', 'error');
                    return;
                }

                fetch(`/api/orders/${currentOrderId}/payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ payment_amount: paymentAmount })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        document.getElementById('paymentModal').style.display = 'none';
                        loadOrders();
                        loadStatistics();
                    } else {
                        showNotification('支付失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('支付失败:', error);
                    showNotification('支付失败', 'error');
                });
            });
        }

        // 确认删除按钮
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                fetch(`/api/orders/${currentOrderId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        document.getElementById('confirmDeleteModal').style.display = 'none';
                        loadOrders();
                        loadStatistics();
                    } else {
                        showNotification('删除失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('删除失败:', error);
                    showNotification('删除失败', 'error');
                });
            });
        }

        // 房间选择和日期变化时检查可用性
        const roomNumberSelect = document.getElementById('room_number');
        const checkInDate = document.getElementById('check_in_date');
        const checkOutDate = document.getElementById('check_out_date');

        if (roomNumberSelect && checkInDate && checkOutDate) {
            roomNumberSelect.addEventListener('change', () => {
                const roomNumber = roomNumberSelect.value;
                const checkIn = checkInDate.value;
                const checkOut = checkOutDate.value;
                const orderId = document.getElementById('order_id').value;

                if (roomNumber && checkIn && checkOut) {
                    checkRoomAvailability(roomNumber, checkIn, checkOut, orderId);
                }
            });

            checkInDate.addEventListener('change', () => {
                const roomNumber = roomNumberSelect.value;
                const checkIn = checkInDate.value;
                const checkOut = checkOutDate.value;
                const orderId = document.getElementById('order_id').value;

                if (roomNumber && checkIn && checkOut) {
                    checkRoomAvailability(roomNumber, checkIn, checkOut, orderId);
                }
            });

            checkOutDate.addEventListener('change', () => {
                const roomNumber = roomNumberSelect.value;
                const checkIn = checkInDate.value;
                const checkOut = checkOutDate.value;
                const orderId = document.getElementById('order_id').value;

                if (roomNumber && checkIn && checkOut) {
                    checkRoomAvailability(roomNumber, checkIn, checkOut, orderId);
                }
            });
        }

        // 关闭模态框
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // 点击模态框外部关闭
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    }

    // 显示通知函数
    function showNotification(message, type = 'info') {
        // 这里可以添加你的通知显示逻辑
        console.log(`${type}: ${message}`);
        alert(`${type}: ${message}`);
    }
</script>
{% endblock %}